# Story 1.3: Role-based authentication and access

## Status
Ready for Review

## Story
**As a** user,
**I want** to sign up or log in as a Company or Freelancer,
**so that** I can access features relevant to my role.

## Acceptance Criteria
1.3.1: Users can register and log in with role selection (Company or Freelancer).
1.3.2: Auth system enforces role-based access restrictions.
1.3.3: Authenticated users are directed to a role-appropriate starting screen.

## Tasks / Subtasks
- [ ] Task 1: Implement auth API endpoints for register/login with role (AC: 1.3.1)
  - [x] Add `POST /auth/register` and `POST /auth/login` in `apps/api/src/modules/auth` [Source: architecture/api-specification.md]
  - [x] Validate inputs with DTOs + `class-validator` and return consistent error shape [Source: architecture/coding-standards.md#critical-fullstack-rules, architecture/error-handling-strategy.md#error-response-format]
  - [x] Register payload includes `email`, `password`, `role` (Company/Freelancer); store `passwordHash` and `role` on `User` [Source: architecture/data-models.md#user]
  - [x] Login payload includes `email`, `password`; role comes from stored user [Source: architecture/backend-architecture.md#authentication-and-authorization]
  - [x] Hash passwords with bcrypt and issue JWTs that include role claims [Source: architecture/tech-stack.md#technology-stack-table]
  - [x] Apply basic rate limiting on auth endpoints [Source: architecture/security-and-performance.md#security-requirements]
- [ ] Task 2: Enforce role-based access in API (AC: 1.3.2)
  - [x] Add/ensure JWT auth guard and role guard on protected endpoints [Source: architecture/backend-architecture.md#authentication-and-authorization, architecture/coding-standards.md#critical-fullstack-rules]
- [ ] Task 3: Build auth UI flows (AC: 1.3.1)
  - [x] Create register and login pages under `apps/web/src/app/(auth)/register/page.tsx` and `apps/web/src/app/(auth)/login/page.tsx` with role selection [Source: architecture/frontend-architecture.md#routing-architecture]
  - [x] Call API via service layer in `apps/web/src/services` (no direct fetch in components) [Source: architecture/coding-standards.md#critical-fullstack-rules]
  - [x] Store auth token per security guidance (prefer httpOnly cookie) and document any deviation [Source: architecture/security-and-performance.md#security-requirements]
- [ ] Task 4: Route users to role-appropriate start screens (AC: 1.3.3)
  - [x] Add/verify role-based redirects to `/company/dashboard` or `/freelancer/jobs` after login [Source: architecture/frontend-architecture.md#routing-architecture]
  - [x] Create minimal placeholder pages for those routes if missing [Source: architecture/frontend-architecture.md#routing-architecture]
- [ ] Task 5: Tests for auth flows (AC: 1.3.1, 1.3.2, 1.3.3)
  - [x] Add frontend unit tests under `apps/web/tests/pages` for role selection and CTA routing [Source: architecture/testing-strategy.md#test-organization]
  - [x] Add backend integration tests under `apps/api/tests/integration` for register/login responses and role enforcement [Source: architecture/testing-strategy.md#test-organization]
  - [x] Include tests for role-based redirect targets after login [Source: architecture/frontend-architecture.md#routing-architecture]

## Dev Notes
- **Previous Story Insights:** Public landing page and auth route structure are defined in the App Router. [Source: architecture/frontend-architecture.md#routing-architecture]
- **Data Models:** Use `User` with `role` and `passwordHash` fields. [Source: architecture/data-models.md#user]
- **API Specifications:** `POST /auth/register` and `POST /auth/login` are required. [Source: architecture/api-specification.md]
- **API Payloads:** Register uses `email`, `password`, `role`; login uses `email`, `password`. [Source: architecture/data-models.md#user, architecture/backend-architecture.md#authentication-and-authorization]
- **Component Specifications:** Auth UI under `(auth)` routes; protected routes under `(company)` and `(freelancer)`. [Source: architecture/frontend-architecture.md#routing-architecture]
- **File Locations:** Backend auth module in `apps/api/src/modules/auth`; frontend pages in `apps/web/src/app/(auth)` and role routes under `apps/web/src/app/(company)` and `apps/web/src/app/(freelancer)`. [Source: architecture/backend-architecture.md#service-architecture, architecture/frontend-architecture.md#component-architecture]
- **Testing Requirements:** Frontend tests in `apps/web/tests/pages`; backend integration tests in `apps/api/tests/integration`. [Source: architecture/testing-strategy.md#test-organization]
- **Technical Constraints:** JWT + bcrypt for auth; role guards on protected endpoints; standard error response format. [Source: architecture/tech-stack.md#technology-stack-table, architecture/coding-standards.md#critical-fullstack-rules, architecture/error-handling-strategy.md#error-response-format]
- **Security Requirements:** Store JWT in httpOnly cookies when possible; apply rate limiting on auth endpoints. [Source: architecture/security-and-performance.md#security-requirements]
- **Environment Variables:** `NEXT_PUBLIC_API_BASE_URL`, `DATABASE_URL`, `JWT_SECRET`, `NODE_ENV`. [Source: architecture/development-workflow.md#environment-configuration]
- **Project Structure Notes:** Follow monorepo layout under `apps/web`, `apps/api`, and `packages/shared`. [Source: architecture/unified-project-structure.md]

### Testing
- **Frameworks:** Vitest + RTL (frontend), Jest + Supertest (backend). [Source: architecture/tech-stack.md#technology-stack-table]
- **Locations:** `apps/web/tests/pages`, `apps/api/tests/integration`. [Source: architecture/testing-strategy.md#test-organization]
- **Pattern:** Validate role selection on UI, and register/login responses with JWT + role using integration tests. [Source: architecture/testing-strategy.md#test-examples]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-05 | 0.1 | Draft story created | Bob |
| 2026-01-05 | 0.2 | Clarified auth payloads, rate limiting, and token storage guidance | Bob |
| 2026-01-05 | 1.0 | Implemented auth flows, guards, UI, and tests | James |
| 2026-01-06 | 1.1 | Fix landing page CTA routes | James |
| 2026-01-06 | 1.2 | Update CTA test expectation | James |
| 2026-01-06 | 1.3 | Enable API CORS for web app | James |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex CLI)

### Debug Log References
N/A

### Completion Notes List
- Added auth module with register/login, JWT issuance, bcrypt hashing, and rate limiting.
- Added JWT auth guard + roles guard and a role-check endpoint for enforcement tests.
- Built login/register UI with role selection and redirect routing plus placeholder role routes.
- Tests: `npm run test`.
- Builds: `npm run build:web`, `npm run build:api`.
- Lint: `npm --workspace apps/web run lint`, `npm --workspace apps/api run lint`.
- Dependencies added: `bcrypt`, `jsonwebtoken`, `@types/bcrypt`, `@types/jsonwebtoken`.
- Note: Vite CJS deprecation warning appears during web tests (no action taken).
- Fixed landing page CTA links to point at /register.
- Updated canary page test to expect /register CTA links.
- Enabled API CORS with configurable origins to unblock local registration.

### File List
- apps/api/src/app.module.ts
- apps/api/src/common/filters/http-exception.filter.ts
- apps/api/src/common/decorators/roles.decorator.ts
- apps/api/src/common/guards/jwt-auth.guard.ts
- apps/api/src/common/guards/roles.guard.ts
- apps/api/src/modules/auth/auth.controller.ts
- apps/api/src/modules/auth/auth.module.ts
- apps/api/src/modules/auth/auth.service.ts
- apps/api/src/modules/auth/auth-rate-limit.middleware.ts
- apps/api/src/modules/auth/dto/login.dto.ts
- apps/api/src/modules/auth/dto/register.dto.ts
- apps/api/tests/integration/auth.e2e-spec.ts
- apps/web/src/app/(auth)/register/page.tsx
- apps/web/src/app/(auth)/login/page.tsx
- apps/web/src/app/(company)/dashboard/page.tsx
- apps/web/src/app/(freelancer)/jobs/page.tsx
- apps/web/src/services/api.ts
- apps/web/src/services/auth.ts
- apps/web/tests/pages/auth-pages.test.tsx
- apps/api/package.json
- package-lock.json
- apps/web/src/app/(public)/page.tsx
- apps/web/tests/pages/canary-page.test.tsx
- apps/api/src/main.ts
- .env.example

## QA Results

### Review Date: 2026-01-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Auth flow is implemented end-to-end with DTO validation, JWT issuance, role guards, and UI flows. Tests cover register/login and role-based redirect handling. Current auth storage is in-memory and role enforcement is demonstrated via a test-only endpoint.

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: Pass (DTO validation, guards, error shape applied)
- Project Structure: Pass (auth module and routes align with architecture)
- Testing Strategy: Pass (unit + integration coverage added)
- All ACs Met: Concerns (role enforcement is only demonstrated on a test endpoint; user storage is in-memory)
- Process: Story status is "Ready for Review"; review workflow expects "Review"

### Improvements Checklist
- [x] Validate register/login flows with role selection
- [x] Validate role-based redirect targets on UI
- [x] Validate role-guard enforcement via integration test
- [ ] Persist users via a data layer instead of in-memory map
- [ ] Apply role guards to actual protected business endpoints (beyond role-check)

### Security Review
JWTs are issued and stored in httpOnly cookies; rate limiting is in-memory and process-local. Consider persistence or distributed rate limiting for production.

### Performance Considerations
No concerns for current scope; auth logic is lightweight.

### Files Modified During Review
- None.

### Gate Status
Gate: CONCERNS docs/qa/gates/1.3-role-based-authentication-and-access.yml
Risk profile: not created
NFR assessment: not created

### Recommended Status
Changes Required - See unchecked items above



