# Story 1.4: Persist auth users in Postgres (Heroku) - Brownfield Addition

## User Story
As a platform owner,
I want registered users stored in Postgres instead of memory,
so that authentication survives restarts and is production-ready.

## Story Context

**Existing System Integration:**

- Integrates with: NestJS auth module (`apps/api/src/modules/auth`)
- Technology: TypeScript, NestJS 10, PostgreSQL 16, TypeORM
- Follows pattern: NestJS service/module structure with DTO validation and standard error filter
- Touch points: `auth.service.ts`, auth tests under `apps/api/tests/integration`, env config

## Acceptance Criteria

**Functional Requirements:**

1. Auth register/login persist and read users from Postgres using TypeORM.
2. User records include `email`, `passwordHash`, `role`, `name`, `companyName`, and `status` (`active`, `pending`, `disabled`) with unique email constraint.
3. Existing auth response shape (token, role) remains unchanged.

**Integration Requirements:**

4. Existing auth endpoints continue to work without API changes.
5. Database configuration uses `DATABASE_URL` and supports Heroku Postgres SSL in production.
6. Validation and error handling remain consistent with current DTO + filter behavior.

**Quality Requirements:**

7. Integration tests cover register/login using the database-backed repository.
8. No regression in role-based redirects or auth flows verified.
9. Documentation (env/config notes) updated if needed.

## Tasks / Subtasks

- [x] Task 1: Add TypeORM and Postgres configuration
  - [x] Add TypeORM and pg dependencies in `apps/api/package.json`
  - [x] Configure TypeORM module in `apps/api/src/app.module.ts`
  - [x] Use `DATABASE_URL` and enable SSL for Heroku in production
- [x] Task 2: Create `User` entity
  - [x] Add `email` (unique), `passwordHash`, `role`
  - [x] Add `name`, `companyName` (nullable)
  - [x] Add `status` enum (`active`, `pending`, `disabled`) with default `pending`
- [x] Task 3: Update auth service to use repository
  - [x] Replace in-memory map with TypeORM repository
  - [x] Register: enforce unique email, hash password, persist user
  - [x] Login: lookup by email, verify password, role check
- [x] Task 4: Update tests
  - [x] Ensure integration tests cover DB-backed register/login
  - [x] Verify no regressions in auth responses and role behavior
- [x] Task 5: Docs/config updates
  - [x] Update `.env.example` if new DB settings are required
  - [x] Note Heroku SSL requirement in config comments

## Technical Notes

- **Integration Approach:** Replace in-memory user map with a TypeORM `User` entity and repository in the auth module.
- **Existing Pattern Reference:** Follow current NestJS service/module pattern and DTO validation in `apps/api/src/modules/auth`.
- **Key Constraints:** Use existing `DATABASE_URL`; ensure SSL configuration for Heroku environments.
- **Field Notes:** If `name`, `companyName`, or `status` are not collected yet, allow nullable fields with safe defaults.

## Definition of Done

- [x] Functional requirements met
- [x] Integration requirements verified
- [ ] Existing functionality regression tested
- [x] Code follows existing patterns and standards
- [x] Tests pass (existing and new)
- [x] Documentation updated if applicable

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** Misconfigured DB connection or SSL causing auth outage.
- **Mitigation:** Keep local fallback config and validate against Heroku Postgres requirements.
- **Rollback:** Revert to in-memory map and redeploy.

**Compatibility Verification:**

- [ ] No breaking changes to existing APIs
- [ ] Database changes are additive only
- [ ] UI behavior unchanged
- [ ] Performance impact is negligible for auth volume

## Validation Checklist

**Scope Validation:**

- [ ] Story can be completed in one development session
- [ ] Integration approach is straightforward
- [ ] Follows existing patterns exactly
- [ ] No design or architecture work required

**Clarity Check:**

- [ ] Story requirements are unambiguous
- [ ] Integration points are clearly specified
- [ ] Success criteria are testable
- [ ] Rollback approach is simple

## Dev Agent Record

### Agent Model Used
- GPT-5

### Debug Log References
- `npm --workspace apps/api test` failed initially: `DATABASE_URL` missing/unreachable, invalid column type metadata, and schema sync race.
- `npm --workspace apps/api test` succeeded after fixes with `NODE_ENV=production` and `DATABASE_URL` provided.

### Completion Notes List
- Implemented TypeORM-backed user persistence and updated auth service/repository wiring.
- Integration tests run serially to avoid schema sync race on enum creation.
- Tests require a reachable Postgres instance via `DATABASE_URL` (SSL enabled when `NODE_ENV=production`).

### File List
- .env.example
- apps/api/package.json
- apps/api/src/app.module.ts
- apps/api/src/modules/auth/auth.module.ts
- apps/api/src/modules/auth/auth.service.ts
- apps/api/src/modules/auth/user.entity.ts
- apps/api/tests/integration/auth.e2e-spec.ts
- apps/api/jest.config.ts
- package-lock.json

### Change Log
- Added TypeORM configuration and `User` entity, switched auth to repository-backed persistence, and updated integration tests/docs for DB usage.

## QA Results

### Review Date: 2026-01-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Solid TypeORM integration and repository usage. Main concern is `synchronize: true` in production, which risks unintended schema changes. Tests pass with a real Postgres URL and are serialized to avoid enum sync races.

### Refactoring Performed
None.

### Compliance Check
- Coding Standards: ✓ DTO validation preserved, error handling unchanged. Shared types not applicable to this change.
- Project Structure: ✓ New entity placed under `apps/api/src/modules/auth`.
- Testing Strategy: ✓ Integration tests updated and passing.
- All ACs Met: ⚠️ AC8 (role-based redirects) not explicitly verified by tests.

### Improvements Checklist
- [ ] Disable TypeORM `synchronize` in production; use migrations instead (`apps/api/src/app.module.ts`).
- [ ] Add e2e coverage for role-based redirect/auth flows (AC8).

### Security Review
JWT + bcrypt usage remains unchanged. Concern: `synchronize: true` in production can cause accidental schema changes (data integrity risk).

### Performance Considerations
No obvious perf regressions for auth volume. Serializing tests increases test time but improves reliability.

### Files Modified During Review
None.

### Gate Status
Gate: CONCERNS → docs/qa/gates/1.4-persist-auth-users-in-postgres-heroku-brownfield-addition.yml
Risk profile: docs/qa/assessments/1.4-risk-20260106.md
NFR assessment: docs/qa/assessments/1.4-nfr-20260106.md

### Recommended Status
[⚠️ Changes Required - See unchecked items above]
