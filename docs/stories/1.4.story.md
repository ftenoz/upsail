# Story 1.4: Persist auth users in Postgres (Heroku) - Brownfield Addition

## User Story
As a platform owner,
I want registered users stored in Postgres instead of memory,
so that authentication survives restarts and is production-ready.

## Story Context

**Existing System Integration:**

- Integrates with: NestJS auth module (`apps/api/src/modules/auth`)
- Technology: TypeScript, NestJS 10, PostgreSQL 16, TypeORM
- Follows pattern: NestJS service/module structure with DTO validation and standard error filter
- Touch points: `auth.service.ts`, auth tests under `apps/api/tests/integration`, env config

## Acceptance Criteria

**Functional Requirements:**

1. Auth register/login persist and read users from Postgres using TypeORM.
2. User records include `email`, `passwordHash`, `role`, `name`, `companyName`, and `status` (`active`, `pending`, `disabled`) with unique email constraint.
3. Existing auth response shape (token, role) remains unchanged.

**Integration Requirements:**

4. Existing auth endpoints continue to work without API changes.
5. Database configuration uses `DATABASE_URL` and supports Heroku Postgres SSL in production.
6. Validation and error handling remain consistent with current DTO + filter behavior.

**Quality Requirements:**

7. Integration tests cover register/login using the database-backed repository.
8. No regression in role-based redirects or auth flows verified.
9. Documentation (env/config notes) updated if needed.

## Tasks / Subtasks

- [ ] Task 1: Add TypeORM and Postgres configuration
  - [ ] Add TypeORM and pg dependencies in `apps/api/package.json`
  - [ ] Configure TypeORM module in `apps/api/src/app.module.ts`
  - [ ] Use `DATABASE_URL` and enable SSL for Heroku in production
- [ ] Task 2: Create `User` entity
  - [ ] Add `email` (unique), `passwordHash`, `role`
  - [ ] Add `name`, `companyName` (nullable)
  - [ ] Add `status` enum (`active`, `pending`, `disabled`) with default `pending`
- [ ] Task 3: Update auth service to use repository
  - [ ] Replace in-memory map with TypeORM repository
  - [ ] Register: enforce unique email, hash password, persist user
  - [ ] Login: lookup by email, verify password, role check
- [ ] Task 4: Update tests
  - [ ] Ensure integration tests cover DB-backed register/login
  - [ ] Verify no regressions in auth responses and role behavior
- [ ] Task 5: Docs/config updates
  - [ ] Update `.env.example` if new DB settings are required
  - [ ] Note Heroku SSL requirement in config comments

## Technical Notes

- **Integration Approach:** Replace in-memory user map with a TypeORM `User` entity and repository in the auth module.
- **Existing Pattern Reference:** Follow current NestJS service/module pattern and DTO validation in `apps/api/src/modules/auth`.
- **Key Constraints:** Use existing `DATABASE_URL`; ensure SSL configuration for Heroku environments.
- **Field Notes:** If `name`, `companyName`, or `status` are not collected yet, allow nullable fields with safe defaults.

## Definition of Done

- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing and new)
- [ ] Documentation updated if applicable

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** Misconfigured DB connection or SSL causing auth outage.
- **Mitigation:** Keep local fallback config and validate against Heroku Postgres requirements.
- **Rollback:** Revert to in-memory map and redeploy.

**Compatibility Verification:**

- [ ] No breaking changes to existing APIs
- [ ] Database changes are additive only
- [ ] UI behavior unchanged
- [ ] Performance impact is negligible for auth volume

## Validation Checklist

**Scope Validation:**

- [ ] Story can be completed in one development session
- [ ] Integration approach is straightforward
- [ ] Follows existing patterns exactly
- [ ] No design or architecture work required

**Clarity Check:**

- [ ] Story requirements are unambiguous
- [ ] Integration points are clearly specified
- [ ] Success criteria are testable
- [ ] Rollback approach is simple
