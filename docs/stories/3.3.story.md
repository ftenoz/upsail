# Story 3.3: Apply to job

## Status
Ready for Review

## Story
**As a** Freelancer user,
**I want** to apply to a job with my profile and a short note,
**so that** I can express interest and qualification.

## Acceptance Criteria
3.3.1: Freelancer can submit an application to a job.
3.3.2: Company can see the application associated with the job.

## Story Context
- Continues the marketplace loop after browsing/filtering so freelancers can apply and companies can review.
- Dependencies: Stories 3.1 (job posting) and 3.2 (job browsing/filtering) are complete.

## Assumptions / Edge Cases
- Freelancer must be authenticated and have a FreelancerProfile to apply.
- Applications should be blocked for closed jobs.
- Duplicate applications to the same job should be prevented or handled consistently.

## Tasks / Subtasks
- [x] Task 1: Define Application domain type and persistence mapping (AC: 3.3.1, 3.3.2)
  - [x] Add shared Application type aligned with data model [Source: architecture/data-models.md#application, architecture/coding-standards.md#critical-fullstack-rules]
  - [x] Map Application persistence to `applications` table schema and indexes [Source: architecture/database-schema.md#database-schema]
- [x] Task 2: Implement applications API endpoints with validation and role guards (AC: 3.3.1, 3.3.2)
  - [x] Add Applications module controller/service for `POST /applications` and `GET /jobs/{jobId}/applications` [Source: architecture/api-specification.md#api-specification, architecture/backend-architecture.md#service-architecture]
  - [x] Enforce freelancer role for apply and company role for list; validate DTOs with class-validator [Source: architecture/coding-standards.md#critical-fullstack-rules, architecture/backend-architecture.md#authentication-and-authorization]
  - [x] Ensure errors use standard API error format [Source: architecture/error-handling-strategy.md#error-response-format]
- [x] Task 3: Build web services and UI for applying and reviewing applications (AC: 3.3.1, 3.3.2)
  - [x] Add applications service functions in `apps/web/src/services` [Source: architecture/frontend-architecture.md#frontend-services-layer]
  - [x] Add freelancer apply UI in `apps/web/src/app/(freelancer)/jobs` (note input) using TanStack Query [Source: architecture/frontend-architecture.md#state-management-architecture, architecture/frontend-architecture.md#routing-architecture]
  - [x] Add company applications view under `apps/web/src/app/(company)/jobs/[jobId]` [Source: architecture/frontend-architecture.md#routing-architecture, architecture/frontend-architecture.md#component-architecture]
- [x] Task 4: Tests for applications flow (AC: 3.3.1, 3.3.2)
  - [x] Backend integration tests for apply and list applications [Source: architecture/testing-strategy.md#test-organization]
  - [x] Frontend tests for apply UI and company applications list [Source: architecture/testing-strategy.md#test-organization]
  - [ ] (Optional) E2E apply flow under `apps/e2e/jobs` or `apps/e2e/applications` [Source: architecture/testing-strategy.md#test-organization]

## Dev Notes
**Previous Story Insights:** No specific guidance found in architecture docs.
**Data Models:**
- Application fields: id, jobId, freelancerId, note, status, createdAt. [Source: architecture/data-models.md#application]
- Job relates to CompanyProfile and Applications. [Source: architecture/data-models.md#job]
- FreelancerProfile is required to apply (freelancerId). [Source: architecture/data-models.md#freelancerprofile]
**Database Schema:**
- `applications` table columns and indexes on job_id and freelancer_id. [Source: architecture/database-schema.md#database-schema]
**API Specifications:**
- `POST /applications` to apply; `GET /jobs/{jobId}/applications` to list. [Source: architecture/api-specification.md#api-specification]
**Core Workflows:**
- Apply flow uses `POST /applications` after browsing jobs. [Source: architecture/core-workflows.md#core-workflows]
**Component Specifications:**
- Route groups `(freelancer)` and `(company)`; company job detail route at `(company)/jobs/[jobId]`. [Source: architecture/frontend-architecture.md#routing-architecture]
- UI components under `apps/web/src/components` and features under `apps/web/src/features/applications`. [Source: architecture/frontend-architecture.md#component-architecture]
**Frontend Services Layer:**
- API calls through `apps/web/src/services`; use TanStack Query for server state. [Source: architecture/frontend-architecture.md#frontend-services-layer, architecture/frontend-architecture.md#state-management-architecture]
**Backend Implementation Notes:**
- Applications module under `apps/api/src/modules/applications` with controller/service pattern. [Source: architecture/backend-architecture.md#service-architecture]
- Protected endpoints require JWT + role guards; DTO validation with class-validator. [Source: architecture/backend-architecture.md#authentication-and-authorization, architecture/coding-standards.md#critical-fullstack-rules]
- Use standard API error format via global exception filter. [Source: architecture/error-handling-strategy.md#error-response-format]
**File Locations:**
- Frontend: `apps/web/src/app`, `apps/web/src/components`, `apps/web/src/features`, `apps/web/src/services`, `apps/web/tests`. [Source: architecture/unified-project-structure.md#unified-project-structure, architecture/frontend-architecture.md#component-architecture]
- Backend: `apps/api/src/modules`, `apps/api/tests`. [Source: architecture/backend-architecture.md#service-architecture, architecture/unified-project-structure.md#unified-project-structure]
- Shared types: `packages/shared/src/types`. [Source: architecture/unified-project-structure.md#unified-project-structure, architecture/components.md#shared-types-package]
**Testing Requirements:**
- Frontend tests under `apps/web/tests/pages` or `apps/web/tests/features`.
- Backend integration tests under `apps/api/tests/integration`.
- E2E tests under `apps/e2e/jobs` or `apps/e2e/applications` if used. [Source: architecture/testing-strategy.md#test-organization]
**Technical Constraints:**
- Shared types only in `packages/shared`; no duplicate interfaces. [Source: architecture/coding-standards.md#critical-fullstack-rules]
- REST API with JWT auth; no external APIs in MVP. [Source: architecture/tech-stack.md#technology-stack-table, architecture/external-apis.md#external-apis]
- API routes use kebab-case; DB tables use snake_case. [Source: architecture/coding-standards.md#naming-conventions]
**Project Structure Notes:** No conflicts found with the unified project structure. [Source: architecture/unified-project-structure.md#unified-project-structure]

### Testing
- Frameworks: Vitest + RTL for frontend, Jest + Supertest for backend, Playwright for E2E. [Source: architecture/tech-stack.md#technology-stack-table]
- Follow testing pyramid and place tests in standard locations. [Source: architecture/testing-strategy.md#testing-pyramid, architecture/testing-strategy.md#test-organization]
- Suggested scenarios: freelancer applies with note, company lists job applications, non-freelancer apply blocked. [Source: architecture/testing-strategy.md#test-examples]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-09 | 0.1 | Draft story created | Bob |
| 2026-01-09 | 0.2 | Implement applications flow and tests | James |

## Dev Agent Record
### Agent Model Used
GPT-5

### Debug Log References
None

### Completion Notes List
- Added shared Application type and backend applications module with guards and validation.
- Built freelancer apply UI and company applications view, plus new services.
- Tests: `npm --workspace apps/api run test`, `npm --workspace apps/web run test`.
- Lint/build: `npm --workspace apps/web run lint`, `npm --workspace apps/api run lint`, `npm run build:shared`, `npm run build:web`, `npm run build:api`.
- Added jobs and applications table migrations (`20260109210000-create-jobs.ts`, `20260109220000-create-applications.ts`).
- Manual UI/API verification not performed.
- Optional E2E flow not implemented.

### File List
- apps/api/src/app.module.ts
- apps/api/src/migrations/20260109210000-create-jobs.ts
- apps/api/src/migrations/20260109220000-create-applications.ts
- apps/api/src/modules/applications/application.entity.ts
- apps/api/src/modules/applications/applications.controller.ts
- apps/api/src/modules/applications/applications.module.ts
- apps/api/src/modules/applications/applications.service.ts
- apps/api/src/modules/applications/dto/create-application.dto.ts
- apps/api/tests/integration/applications.e2e-spec.ts
- apps/web/src/app/company/jobs/[jobId]/page.tsx
- apps/web/src/app/company/jobs/page.tsx
- apps/web/src/app/freelancer/jobs/page.tsx
- apps/web/src/services/applications.ts
- apps/web/tests/pages/company-job-applications.test.tsx
- apps/web/tests/pages/freelancer-jobs.test.tsx
- packages/shared/src/index.ts
- packages/shared/src/types/application.ts

## QA Results
TBD
